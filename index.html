<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kitty Coin Catcher: Musical Edition</title>
    <meta name="description" content="Catch coins, avoid bombs! A musical adventure with cute cats!">
    <meta name="crazygames" content="true">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }
        body { background: #1a1a2e; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .game-wrapper { position: relative; width: 100%; height: 100%; max-width: 600px; max-height: 900px; }
        .game-container { position: relative; width: 100%; height: 100%; background: linear-gradient(180deg, #e0c3fc 0%, #8ec5fc 100%); box-shadow: 0 0 40px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; }
        @media (min-width: 601px) { .game-container { border-radius: 24px; height: 95vh; } }
        .loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #e0c3fc; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: #ff8fa3; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud { padding: 20px; display: flex; justify-content: space-between; pointer-events: auto; }
        .stat-pill { background: #fff; padding: 8px 16px; border-radius: 50px; border: 3px solid #fff; box-shadow: 0 6px 0 rgba(0,0,0,0.1); color: #5e548e; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; border: none; background: #fff; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #c8b6ff; color: #5e548e; display: flex; align-items: center; justify-content: center; transition: 0.1s; pointer-events: auto; }
        .btn-round:active { transform: translateY(4px); box-shadow: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; }
        .hidden { display: none; }
        h1 { font-size: 3.5rem; color: #ff8fa3; text-align: center; line-height: 1; text-shadow: 3px 3px 0 #fff; margin-bottom: 30px; }
        .btn-main { background: linear-gradient(to bottom, #ff8fa3, #ff5d8f); border: none; padding: 18px 60px; border-radius: 60px; font-size: 2rem; color: white; font-weight: 800; cursor: pointer; box-shadow: 0 8px 0 #c9184a; width: 80%; max-width: 350px; }
        .btn-main:active { transform: translateY(8px); box-shadow: 0 0 0 #c9184a; }
        .btn-sec { background: #fff; color: #5e548e; border: 3px solid #efefef; padding: 12px 40px; border-radius: 40px; font-size: 1.3rem; font-weight: 700; cursor: pointer; box-shadow: 0 5px 0 #ddd; margin-top: 15px; }
        .shop-container { background: #fff; border-radius: 20px; padding: 20px; width: 100%; max-width: 400px; max-height: 60vh; overflow-y: auto; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .shop-item { background: #f8f9fa; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 3px solid transparent; }
        .shop-item.equipped { border-color: #ff8fa3; background: #ffe5ec; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    </style>
    <script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
</head>
<body>
<div class="game-wrapper">
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <h2 style="color:#5e548e">INITIALIZING SDK...</h2>
    </div>

    <div class="game-container" id="gameContainer">
        <div class="ui-layer">
            <div class="hud">
                <div>
                    <div class="stat-pill" style="color: #ffb703;">ü™ô <span id="uiScore">0</span></div>
                    <div class="stat-pill" style="color: #ff5d8f; margin-top:10px;" id="uiLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                </div>
                <button class="btn-round" id="btnPause">II</button>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="screen" id="screenStart">
            <h1>KITTY CATCH</h1>
            <button class="btn-main" id="btnPlay">PLAY</button>
            <button class="btn-sec" id="btnShop">SKINS</button>
            <div style="margin-top:20px;"><button class="btn-round" id="btnMute">üéµ</button></div>
        </div>

        <div class="screen hidden" id="screenShop">
            <h2 style="margin-bottom:20px;">WARDROBE</h2>
            <div class="shop-container"><div class="shop-grid" id="shopGrid"></div></div>
            <button class="btn-sec" id="btnCloseShop">BACK</button>
        </div>

        <div class="screen hidden" id="screenOver">
            <h1>GAME OVER</h1>
            <div style="font-size: 3rem; color:#ff8fa3;" id="uiFinalScore">0</div>
            <p style="color:#666; margin-bottom:20px;">BEST: <span id="uiBestScore">0</span></p>
            <button class="btn-main" id="btnRestart">AGAIN</button>
            <button class="btn-sec" id="btnHome">MENU</button>
        </div>

        <div class="screen hidden" id="screenPause">
            <h1>PAUSED</h1>
            <button class="btn-main" id="btnResume">RESUME</button>
            <button class="btn-sec" id="btnQuit">QUIT</button>
        </div>
    </div>
</div>

<script>
/** * 1. MANDATORY SCROLL PREVENTION (CG Requirement) */
window.addEventListener("wheel", (event) => event.preventDefault(), { passive: false });
window.addEventListener("keydown", (event) => {
    if (["ArrowUp", "ArrowDown", " ", "ArrowLeft", "ArrowRight"].includes(event.key)) {
        event.preventDefault();
    }
});

/** * 2. SDK v3 MANAGER */
const CrazyManager = (() => {
    let sdk = null;
    return {
        init: async () => {
            try {
                sdk = await window.CrazyGames.SDK.init();
                sdk.game.loadingStart(); // Required signal
                return true;
            } catch (e) { console.error("SDK Init Error", e); return false; }
        },
        loadingStop: () => sdk?.game.loadingStop(),
        gameplayStart: () => sdk?.game.gameplayStart(),
        gameplayStop: () => sdk?.game.gameplayStop(),
        happyTime: () => sdk?.game.happyTime(),
        requestAd: async (type) => {
            if (!sdk || window.CrazyGames.SDK.environment === 'disabled') return;
            try { await sdk.ad.requestAd(type); } catch (e) { console.warn("Ad skip", e); }
        },
        save: async (data) => {
            if (sdk?.data) await sdk.data.setItem('kittyData', JSON.stringify(data));
            localStorage.setItem('kittyData', JSON.stringify(data));
        },
        load: async () => {
            if (sdk?.data) {
                const cloud = await sdk.data.getItem('kittyData');
                if (cloud) return JSON.parse(cloud);
            }
            const local = localStorage.getItem('kittyData');
            return local ? JSON.parse(local) : null;
        }
    };
})();

/** * 3. CORE GAME MECHANICS (UNTOUCHED) */
const CONSTANTS = { PLAYER_W: 70, PLAYER_H: 55, COLORS: { coin: '#ffb703', bomb: '#ef233c', heart: '#ff8fa3' }};
const SKINS = [
    { id: 'classic', name: 'Classic', cost: 0, color: '#ffcdb2', emoji: 'üò∫' },
    { id: 'void', name: 'Void', cost: 300, color: '#343a40', emoji: 'üêà‚Äç‚¨õ' },
    { id: 'tiger', name: 'Tiger', cost: 500, color: '#ff9f1c', emoji: 'üêØ' }
];

let GameState = { score: 0, lives: 3, coins: 0, bestScore: 0, inventory: ['classic'], equipped: 'classic', active: false, sound: true };
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let w, h, player = { x: 0, y: 0, targetX: 0 }, entities = [];

function resize() {
    const rect = document.getElementById('gameContainer').getBoundingClientRect();
    w = rect.width; h = rect.height;
    canvas.width = w; canvas.height = h;
    player.y = h - 100;
}

function spawn() {
    if(!GameState.active) return;
    const type = Math.random() > 0.85 ? 'bomb' : 'coin';
    entities.push({ x: Math.random() * (w-50)+25, y: -30, type, speed: 3 + (GameState.score/200) });
}

function update() {
    if(!GameState.active) return;
    player.x += (player.targetX - player.x) * 0.15;
    if(Math.random() < 0.03) spawn();
    for(let i=entities.length-1; i>=0; i--) {
        let e = entities[i]; e.y += e.speed;
        if(e.y > player.y && e.y < player.y + 40 && Math.abs(e.x - (player.x + 35)) < 40) {
            if(e.type === 'coin') { GameState.score += 10; CrazyManager.happyTime(); }
            else { GameState.lives--; if(GameState.lives <= 0) endGame(); }
            entities.splice(i, 1); updateUI();
        } else if(e.y > h) entities.splice(i, 1);
    }
}

function draw() {
    ctx.clearRect(0, 0, w, h);
    entities.forEach(e => {
        ctx.fillStyle = CONSTANTS.COLORS[e.type];
        ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI*2); ctx.fill();
    });
    const skin = SKINS.find(s => s.id === GameState.equipped);
    ctx.fillStyle = skin.color;
    ctx.fillRect(player.x, player.y, 70, 40);
    ctx.fillStyle = "#000"; ctx.font = "20px Fredoka"; ctx.fillText(skin.emoji, player.x+22, player.y+28);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }

async function endGame() {
    GameState.active = false;
    if(GameState.score > GameState.bestScore) GameState.bestScore = GameState.score;
    GameState.coins += GameState.score;
    document.getElementById('uiFinalScore').textContent = GameState.score;
    document.getElementById('uiBestScore').textContent = GameState.bestScore;
    toggleScreen('over');
    await CrazyManager.save(GameState);
    CrazyManager.requestAd('midgame');
}

function updateUI() {
    document.getElementById('uiScore').textContent = GameState.score;
    document.getElementById('uiLives').textContent = '‚ù§Ô∏è'.repeat(GameState.lives);
}

function toggleScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('screen' + id.charAt(0).toUpperCase() + id.slice(1)).classList.remove('hidden');
    if(id === 'play') { GameState.active = true; CrazyManager.gameplayStart(); }
    else { GameState.active = false; CrazyManager.gameplayStop(); }
}

// Controls
canvas.addEventListener('mousemove', e => player.targetX = e.offsetX - 35);
canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    player.targetX = e.touches[0].pageX - canvas.offsetLeft - 35;
}, {passive: false});

// Initialization
window.addEventListener('load', async () => {
    resize();
    window.addEventListener('resize', resize);
    
    await CrazyManager.init();
    const savedData = await CrazyManager.load();
    if(savedData) Object.assign(GameState, savedData);

    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
        CrazyManager.loadingStop();
    }, 1000);

    loop();
});

// UI Listeners
document.getElementById('btnPlay').onclick = () => { GameState.score = 0; GameState.lives = 3; entities = []; updateUI(); toggleScreen('play'); };
document.getElementById('btnRestart').onclick = () => document.getElementById('btnPlay').click();
document.getElementById('btnPause').onclick = () => toggleScreen('pause');
document.getElementById('btnResume').onclick = () => toggleScreen('play');
document.getElementById('btnHome').onclick = () => toggleScreen('start');
document.getElementById('btnShop').onclick = () => {
    const grid = document.getElementById('shopGrid'); grid.innerHTML = '';
    SKINS.forEach(s => {
        const item = document.createElement('div');
        item.className = `shop-item ${GameState.equipped === s.id ? 'equipped' : ''}`;
        item.innerHTML = `<div>${s.emoji}</div><div>${s.name}</div>`;
        item.onclick = () => { GameState.equipped = s.id; toggleScreen('shop'); CrazyManager.save(GameState); };
        grid.appendChild(item);
    });
    toggleScreen('shop');
};
document.getElementById('btnCloseShop').onclick = () => toggleScreen('start');
document.getElementById('btnQuit').onclick = () => toggleScreen('start');
document.getElementById('btnMute').onclick = (e) => {
    GameState.sound = !GameState.sound;
    e.target.textContent = GameState.sound ? 'üéµ' : 'üîá';
};

// Canvas Helper
if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        this.beginPath(); this.moveTo(x + r, y);
        this.lineTo(x + w - r, y); this.quadraticCurveTo(x + w, y, x + w, y + r);
        this.lineTo(x + w, y + h - r); this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        this.lineTo(x + r, y + h); this.quadraticCurveTo(x, y + h, x, y + h - r);
        this.lineTo(x, y + r); this.quadraticCurveTo(x, y, x + r, y);
        this.closePath(); return this;
    };
}
</script>
</body>
</html>
