<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Ninja Deluxe</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght@800&display=swap">
    <style>
        :root {
            --primary: #FF6B8B;
            --secondary: #FF8E53;
            --accent: #FFD166;
            --dark: #3A3A3A;
            --light: #FFF9F2;
            --success: #06D6A0;
            --warning: #FFD166;
            --danger: #EF476F;
            --bg-gradient: linear-gradient(135deg, #A1C4FD 0%, #C2E9FB 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: all 0.5s ease;
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            z-index: 1;
        }

        /* Menu Screen */
        .menu-screen {
            background: rgba(255, 249, 242, 0.95);
            backdrop-filter: blur(10px);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
            animation: float 3s ease-in-out infinite;
        }

        .logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
            margin-bottom: 10px;
        }

        .fruit-decoration {
            font-size: 3rem;
            letter-spacing: 15px;
            margin-left: 15px;
            color: var(--dark);
            opacity: 0.8;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 300px;
        }

        .difficulty-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .difficulty-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            color: var(--dark);
            padding: 15px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .difficulty-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }

        /* Game Screen */
        .game-screen {
            background: var(--bg-gradient);
        }

        .game-header {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
        }

        .score-box, .lives-box, .highscore-btn, .difficulty-display {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.5);
        }

        .score-box {
            color: var(--dark);
        }

        .lives-box {
            color: var(--danger);
        }

        .difficulty-display {
            color: var(--primary);
        }

        .highscore-btn {
            cursor: pointer;
            transition: all 0.3s;
        }

        .highscore-btn:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 1);
        }

        #game-canvas {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="%23FF6B8B" d="M6.92 5.51L3.71 2.29 2.29 3.71 5.5 6.92 4 8h5.59l2 2H2v2h13.59l4 4H20v-5.59l2-2V16c0 1.1-.9 2-2 2h-4.18c-.41 1.16-1.51 2-2.82 2-1.31 0-2.41-.84-2.82-2H6c-1.1 0-2-.9-2-2V8c0-.55.22-1.05.59-1.41L6.92 5.51zM16 18c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1z"/></svg>') 16 16, auto;
            position: relative;
            overflow: hidden;
        }

        .game-canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.05) 100%);
        }

        /* High Scores Screen */
        .highscores-screen {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }

        .highscores-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            animation: cardEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .highscores-list {
            list-style: none;
            margin: 20px 0;
            text-align: left;
            font-size: 1.2rem;
        }

        .highscores-list li {
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
        }

        .highscores-list li:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 64, 0.3) 0%, rgba(255, 255, 255, 0.7) 100%);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .highscores-list li:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(255, 255, 255, 0.7) 100%);
        }

        .highscores-list li:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(255, 255, 255, 0.7) 100%);
        }

        /* Game Over Screen */
        .game-over-screen {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            animation: cardEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .result-container {
            margin: 30px 0;
        }

        .final-score {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 10px 0;
            text-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }

        .fruit-celebration {
            font-size: 3.5rem;
            letter-spacing: 15px;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            color: white;
            padding: 18px 32px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 20px rgba(255, 107, 139, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(255, 107, 139, 0.4);
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(255, 107, 139, 0.4);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(-20px); }
            50% { transform: translateY(20px); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes cardEnter {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* Particles */
        .particle {
            position: absolute;
            background: currentColor;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
        }

        /* Floating fruits background */
        .floating-fruits {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-fruit {
            position: absolute;
            font-size: 3rem;
            opacity: 0.1;
            animation: float 15s infinite linear;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 3.5rem;
            }
            
            .fruit-decoration {
                font-size: 2.5rem;
                letter-spacing: 10px;
            }
            
            .game-header {
                flex-direction: column;
                align-items: center;
                gap: 15px;
                top: 10px;
            }
            
            .card, .highscores-container {
                padding: 30px 20px;
            }
            
            .final-score {
                font-size: 3rem;
            }
            
            .fruit-celebration {
                font-size: 2.5rem;
                letter-spacing: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating fruits background -->
    <div class="floating-fruits" id="floating-fruits"></div>

    <!-- Menu Screen -->
    <div id="menu-screen" class="screen menu-screen active">
        <div class="logo-container">
            <h1 class="logo">FRUIT NINJA</h1>
            <div class="fruit-decoration">🍎🍊🍋🍉🍓🍍</div>
        </div>
        <div class="difficulty-buttons">
            <button id="easy-btn" class="difficulty-btn active">🍎 Easy</button>
            <button id="medium-btn" class="difficulty-btn">🍊 Medium</button>
            <button id="hard-btn" class="difficulty-btn">🍋 Hard</button>
        </div>
        <div class="button-group">
            <button id="start-btn" class="btn">🍴 START SLICING</button>
            <button id="highscores-menu-btn" class="btn">🏆 HIGH SCORES</button>
            <button id="instructions-btn" class="btn">📖 HOW TO PLAY</button>
        </div>
    </div>

    <!-- Instructions Screen -->
    <div id="instructions-screen" class="screen menu-screen">
        <div class="card">
            <h2>HOW TO PLAY</h2>
            <div class="instructions-content">
                <p>🍉 SLICE flying fruits with your finger or mouse</p>
                <p>💥 AVOID bombs - they cost you lives!</p>
                <p>🌟 SPECIAL fruits give bonus points</p>
                <p>❤️ You have 3 lives - game ends when you lose them all</p>
                <p>⚡ Chain slices for combo bonuses!</p>
                <p>🎚️ Choose difficulty: Easy, Medium, or Hard</p>
            </div>
            <button id="back-to-menu-btn" class="btn">🔙 MAIN MENU</button>
        </div>
    </div>

    <!-- High Scores Screen -->
    <div id="highscores-screen" class="screen highscores-screen">
        <div class="highscores-container">
            <h2>HIGH SCORES</h2>
            <div class="difficulty-tabs">
                <button class="difficulty-tab active" data-difficulty="easy">Easy</button>
                <button class="difficulty-tab" data-difficulty="medium">Medium</button>
                <button class="difficulty-tab" data-difficulty="hard">Hard</button>
            </div>
            <ul class="highscores-list" id="highscores-list">
                <!-- Scores will be inserted here -->
            </ul>
            <button id="back-to-menu-btn-2" class="btn">🔙 MAIN MENU</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen game-screen">
        <div class="game-header">
            <div class="score-box">
                <span>SCORE:</span>
                <span id="score">0</span>
            </div>
            <div class="difficulty-display" id="difficulty-display">
                <span id="current-difficulty">Easy</span>
            </div>
            <div class="lives-box">
                <span>LIVES:</span>
                <span id="lives">❤️❤️❤️</span>
            </div>
        </div>
        <canvas id="game-canvas"></canvas>
        <div class="game-canvas-overlay"></div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen game-over-screen">
        <div class="card">
            <h2>GAME OVER!</h2>
            <div class="result-container">
                <p>YOUR FINAL SCORE:</p>
                <p id="final-score" class="final-score">0</p>
                <div class="fruit-celebration">🍉🍎🍊🍋🍓🍍</div>
            </div>
            <div class="button-group">
                <button id="restart-btn" class="btn">🔄 PLAY AGAIN</button>
                <button id="menu-btn" class="btn">🏠 MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
        // Game elements
        const menuScreen = document.getElementById('menu-screen');
        const instructionsScreen = document.getElementById('instructions-screen');
        const highscoresScreen = document.getElementById('highscores-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const startBtn = document.getElementById('start-btn');
        const easyBtn = document.getElementById('easy-btn');
        const mediumBtn = document.getElementById('medium-btn');
        const hardBtn = document.getElementById('hard-btn');
        const highscoresMenuBtn = document.getElementById('highscores-menu-btn');
        const instructionsBtn = document.getElementById('instructions-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const backToMenuBtn2 = document.getElementById('back-to-menu-btn-2');
        const restartBtn = document.getElementById('restart-btn');
        const menuBtn = document.getElementById('menu-btn');
        const gameCanvas = document.getElementById('game-canvas');
        const ctx = gameCanvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const finalScoreElement = document.getElementById('final-score');
        const highscoresList = document.getElementById('highscores-list');
        const difficultyDisplay = document.getElementById('current-difficulty');
        const floatingFruitsContainer = document.getElementById('floating-fruits');
        const difficultyTabs = document.querySelectorAll('.difficulty-tab');

        // Game variables
        let score = 0;
        let highScore = 0;
        let lives = 3;
        let gameInterval;
        let isGameRunning = false;
        let lastSpawnTime = 0;
        let spawnRate = 1200;
        let trail = [];
        let maxTrailLength = 15;
        let particles = [];
        let combo = 0;
        let lastSliceTime = 0;
        const comboThreshold = 500;
        const maxParticles = 100;

        // Difficulty levels
        let currentDifficulty = 'easy';
        const difficulties = {
            easy: {
                name: 'Easy',
                fruitSpeed: 1.5,
                bombChance: 0.1,
                spawnRate: 1200,
                speedIncrease: 0.5
            },
            medium: {
                name: 'Medium',
                fruitSpeed: 2.5,
                bombChance: 0.15,
                spawnRate: 900,
                speedIncrease: 0.8
            },
            hard: {
                name: 'Hard',
                fruitSpeed: 3.5,
                bombChance: 0.2,
                spawnRate: 600,
                speedIncrease: 1.2
            }
        };

        // High scores by difficulty
        let highScores = {
            easy: JSON.parse(localStorage.getItem('fruitNinjaHighScoresEasy')) || [
                { name: 'Player', score: 300 },
                { name: 'Player', score: 200 },
                { name: 'Player', score: 100 }
            ],
            medium: JSON.parse(localStorage.getItem('fruitNinjaHighScoresMedium')) || [
                { name: 'Player', score: 200 },
                { name: 'Player', score: 150 },
                { name: 'Player', score: 100 }
            ],
            hard: JSON.parse(localStorage.getItem('fruitNinjaHighScoresHard')) || [
                { name: 'Player', score: 150 },
                { name: 'Player', score: 100 },
                { name: 'Player', score: 75 }
            ]
        };

        // Fruit data (larger sizes)
        const fruits = [
            { emoji: '🍎', color: '#FF5252', juice: '#FF8A80', points: 1, size: 50 },
            { emoji: '🍊', color: '#FF9800', juice: '#FFCC80', points: 1, size: 50 },
            { emoji: '🍋', color: '#FFEB3B', juice: '#FFF59D', points: 1, size: 50 },
            { emoji: '🍉', color: '#E91E63', juice: '#F48FB1', points: 2, size: 60 },
            { emoji: '🍓', color: '#F44336', juice: '#FFCDD2', points: 2, size: 45 },
            { emoji: '🍍', color: '#FFC107', juice: '#FFE082', points: 1, size: 55 },
            { emoji: '🍌', color: '#FFEB3B', juice: '#FFF59D', points: 1, size: 55 },
            { emoji: '🍒', color: '#F44336', juice: '#FFCDD2', points: 3, size: 45 },
            { emoji: '🥝', color: '#8BC34A', juice: '#C5E1A5', points: 1, size: 50 },
            { emoji: '🍑', color: '#FFAB91', juice: '#FFCCBC', points: 1, size: 55 }
        ];

        const specialFruits = [
            { emoji: '🌟', color: '#FFD740', juice: '#FFE57F', points: 5, size: 55 },
            { emoji: '💎', color: '#40C4FF', juice: '#80D8FF', points: 10, size: 50 }
        ];

        const bombs = [
            { emoji: '💣', color: '#424242', juice: '#9E9E9E', penalty: 1, size: 50 },
            { emoji: '☠️', color: '#212121', juice: '#616161', penalty: 1, size: 50 }
        ];

        // Create floating background fruits
        function createFloatingFruits() {
            const fruits = ['🍎', '🍊', '🍋', '🍉', '🍓', '🍍', '🍌', '🍒'];
            floatingFruitsContainer.innerHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const fruit = document.createElement('div');
                fruit.className = 'floating-fruit';
                fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
                fruit.style.left = `${Math.random() * 100}%`;
                fruit.style.top = `${Math.random() * 100}%`;
                fruit.style.animationDuration = `${15 + Math.random() * 20}s`;
                fruit.style.animationDelay = `-${Math.random() * 20}s`;
                fruit.style.transform = `scale(${0.5 + Math.random() * 0.5})`;
                floatingFruitsContainer.appendChild(fruit);
            }
        }

        // Fruit objects
        let activeFruits = [];

        // Set canvas size
        function resizeCanvas() {
            gameCanvas.width = Math.min(window.innerWidth * 0.95, 800);
            gameCanvas.height = Math.min(window.innerHeight * 0.8, 600);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        createFloatingFruits();

        // Button event listeners
        startBtn.addEventListener('click', startGame);
        easyBtn.addEventListener('click', () => setDifficulty('easy'));
        mediumBtn.addEventListener('click', () => setDifficulty('medium'));
        hardBtn.addEventListener('click', () => setDifficulty('hard'));
        highscoresMenuBtn.addEventListener('click', showHighscores);
        instructionsBtn.addEventListener('click', showInstructions);
        backToMenuBtn.addEventListener('click', showMenu);
        backToMenuBtn2.addEventListener('click', showMenu);
        restartBtn.addEventListener('click', startGame);
        menuBtn.addEventListener('click', showMenu);

        // Difficulty tab event listeners
        difficultyTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                difficultyTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updateHighscoresList(tab.dataset.difficulty);
            });
        });

        // Set difficulty level
        function setDifficulty(difficulty) {
            currentDifficulty = difficulty;
            difficultyDisplay.textContent = difficulties[difficulty].name;
            
            // Update active button
            easyBtn.classList.remove('active');
            mediumBtn.classList.remove('active');
            hardBtn.classList.remove('active');
            document.getElementById(`${difficulty}-btn`).classList.add('active');
        }

        // Screen navigation functions
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function showMenu() {
            showScreen(menuScreen);
            createFloatingFruits();
            updateHighScoreDisplay();
        }

        function showInstructions() {
            showScreen(instructionsScreen);
        }

        function showHighscores() {
            updateHighscoresList(currentDifficulty);
            showScreen(highscoresScreen);
        }

        function showGameScreen() {
            showScreen(gameScreen);
        }

        function showGameOver() {
            updateHighScores();
            showScreen(gameOverScreen);
        }

        // High scores functions
        function updateHighScores() {
            const difficulty = currentDifficulty;
            
            // Update high score if current score is higher
            if (score > highScore) {
                highScore = score;
                localStorage.setItem(`fruitNinjaHighScore${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`, highScore);
            }
            
            // Add to high scores list
            highScores[difficulty].push({ name: 'Player', score: score });
            highScores[difficulty].sort((a, b) => b.score - a.score);
            highScores[difficulty] = highScores[difficulty].slice(0, 5);
            localStorage.setItem(`fruitNinjaHighScores${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`, 
                               JSON.stringify(highScores[difficulty]));
            
            updateHighScoreDisplay();
        }

        function updateHighscoresList(difficulty) {
            highscoresList.innerHTML = '';
            highScores[difficulty].slice(0, 3).forEach((score, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${index + 1}. ${score.name}</span><span>${score.score}</span>`;
                highscoresList.appendChild(li);
            });
        }

        function updateHighScoreDisplay() {
            const highScoreKey = `fruitNinjaHighScore${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}`;
            highScore = localStorage.getItem(highScoreKey) || 0;
        }

        // Game functions
        function startGame() {
            // Reset game state
            score = 0;
            lives = 3;
            combo = 0;
            activeFruits = [];
            trail = [];
            particles = [];
            
            // Update UI
            scoreElement.textContent = score;
            livesElement.textContent = '❤️'.repeat(lives);
            finalScoreElement.textContent = score;
            difficultyDisplay.textContent = difficulties[currentDifficulty].name;
            
            // Set initial spawn rate based on difficulty
            spawnRate = difficulties[currentDifficulty].spawnRate;
            
            // Show game screen
            showGameScreen();
            
            // Start game loop
            if (isGameRunning) {
                cancelAnimationFrame(gameInterval);
            }
            
            isGameRunning = true;
            lastSpawnTime = performance.now();
            gameLoop();
        }

        function gameLoop(timestamp) {
            if (!isGameRunning) return;
            
            // Clear canvas with semi-transparent background for motion blur effect
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // Spawn new fruits (optimized to maintain performance)
            if (timestamp - lastSpawnTime > spawnRate && activeFruits.length < 10) {
                spawnFruit();
                lastSpawnTime = timestamp;
                
                // Gradual difficulty increase based on current difficulty
                const diffSettings = difficulties[currentDifficulty];
                spawnRate = Math.max(300, diffSettings.spawnRate - score * diffSettings.speedIncrease / 100);
            }
            
            // Update and draw fruits (optimized loop)
            for (let i = activeFruits.length - 1; i >= 0; i--) {
                const fruit = activeFruits[i];
                
                // Update position with easing
                const speedMultiplier = difficulties[currentDifficulty].fruitSpeed;
                fruit.y += fruit.speed * speedMultiplier * (fruit.isSliced ? 1.3 : 1);
                fruit.x += fruit.xSpeed;
                fruit.rotation += fruit.rotationSpeed;
                
                // Bounce off walls
                if (fruit.x <= 0 || fruit.x >= gameCanvas.width - fruit.size) {
                    fruit.xSpeed *= -0.8;
                }
                
                // Check if fruit is out of bounds
                if (fruit.y > gameCanvas.height + 50) {
                    if (!fruit.isSliced && !fruit.isBomb) {
                        loseLife();
                    }
                    activeFruits.splice(i, 1);
                    continue;
                }
                
                // Draw fruit
                drawFruit(fruit);
            }
            
            // Update and draw particles (performance optimized)
            const maxParticlesToDraw = Math.min(particles.length, maxParticles);
            for (let i = maxParticlesToDraw - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
                p.life--;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                    continue;
                }
                
                ctx.globalAlpha = p.life / p.maxLife;
                
                if (p.text) {
                    p.draw(ctx);
                } else {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            ctx.globalAlpha = 1;
            
            // Draw trail (optimized)
            if (trail.length > 1) {
                drawTrail();
            }
            
            // Draw combo counter if active
            if (combo > 1) {
                const timeSinceLastSlice = timestamp - lastSliceTime;
                if (timeSinceLastSlice < 1000) {
                    const alpha = 1 - (timeSinceLastSlice / 1000);
                    ctx.font = 'bold 24px Poppins';
                    ctx.fillStyle = `rgba(255, 215, 64, ${alpha})`;
                    ctx.textAlign = 'center';
                    ctx.fillText(`COMBO x${combo}!`, gameCanvas.width / 2, 50);
                    ctx.textAlign = 'left';
                }
            }
            
            // Continue game loop
            gameInterval = requestAnimationFrame(gameLoop);
        }

        function spawnFruit() {
            const diffSettings = difficulties[currentDifficulty];
            const rand = Math.random();
            let fruitData;
            
            // Determine fruit type based on difficulty
            if (rand < 0.1) {
                fruitData = specialFruits[Math.floor(Math.random() * specialFruits.length)];
            } else if (rand < diffSettings.bombChance) {
                fruitData = bombs[Math.floor(Math.random() * bombs.length)];
                fruitData.isBomb = true;
            } else {
                fruitData = fruits[Math.floor(Math.random() * fruits.length)];
            }
            
            const size = fruitData.size;
            const baseSpeed = 1 + Math.random() * 2;
            const speed = baseSpeed + score / 1000;
            
            const fruit = {
                ...fruitData,
                x: Math.random() * (gameCanvas.width - size),
                y: -size,
                size: size,
                speed: speed,
                xSpeed: (Math.random() - 0.5) * 1.5,
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: (Math.random() - 0.5) * 0.05,
                isSliced: false,
                slicedTime: 0,
                slices: [],
                popScale: 1
            };
            
            activeFruits.push(fruit);
        }

        function drawFruit(fruit) {
            ctx.save();
            ctx.translate(fruit.x + fruit.size / 2, fruit.y + fruit.size / 2);
            ctx.rotate(fruit.rotation);
            
            if (fruit.isSliced) {
                // Draw sliced parts with pop animation
                ctx.font = `bold ${fruit.size}px Arial`;
                
                // Create juice splash if not already done
                if (fruit.slices.length > 0 && !fruit.juiceDrawn) {
                    createJuiceSplash(fruit);
                    fruit.juiceDrawn = true;
                    
                    // Add pop animation
                    fruit.popScale = 1.5;
                }
                
                // Apply pop animation
                const popProgress = Math.min(1, (performance.now() - fruit.slicedTime) / 200);
                const currentScale = 1 + (fruit.popScale - 1) * (1 - popProgress);
                ctx.scale(currentScale, currentScale);
                
                // Draw two halves of the fruit flying apart
                const timeSinceSliced = performance.now() - fruit.slicedTime;
                const separation = Math.min(50, timeSinceSliced / 15);
                const rotation = Math.min(0.3, timeSinceSliced / 800);
                
                // Left half
                ctx.save();
                ctx.rotate(-rotation);
                ctx.fillStyle = fruit.color;
                ctx.fillText(fruit.emoji, -fruit.size / 2 - separation, 0);
                ctx.restore();
                
                // Right half
                ctx.save();
                ctx.rotate(rotation);
                ctx.fillStyle = fruit.color;
                ctx.fillText(fruit.emoji, fruit.size / 2 + separation, 0);
                ctx.restore();
                
            } else {
                // Draw whole fruit with shadow
                ctx.font = `bold ${fruit.size}px Arial`;
                
                // Shadow
                ctx.save();
                ctx.translate(3, 3);
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillText(fruit.emoji, -fruit.size / 2, 0);
                ctx.restore();
                
                // Fruit
                ctx.fillStyle = fruit.color;
                ctx.fillText(fruit.emoji, -fruit.size / 2, 0);
                
                // Highlight for special fruits
                if (fruit.points > 3) {
                    ctx.save();
                    ctx.translate(-fruit.size / 2, 0);
                    ctx.rotate(performance.now() / 200);
                    ctx.strokeStyle = 'rgba(255, 215, 64, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(0, 0, fruit.size * 0.6, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
            }
            
            ctx.restore();
        }

        function createJuiceSplash(fruit) {
            const particleCount = fruit.isBomb ? 8 : 12;
            const particleSize = fruit.isBomb ? 3 : 4;
            
            // Limit particles for performance
            if (particles.length < maxParticles) {
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 0.5 + Math.random() * 2;
                    
                    particles.push({
                        x: fruit.x + fruit.size / 2,
                        y: fruit.y + fruit.size / 2,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed - 1.5,
                        radius: particleSize + Math.random() * particleSize,
                        color: fruit.juice,
                        gravity: 0.05,
                        life: 30 + Math.random() * 50,
                        maxLife: 80
                    });
                }
            }
        }

        function drawTrail() {
            // Glowing trail effect (optimized)
            ctx.strokeStyle = 'rgba(255, 107, 139, 0.7)';
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(trail[0].x, trail[0].y);
            
            // Draw every other point for performance
            for (let i = 1; i < trail.length; i += 2) {
                const point = trail[i];
                ctx.lineTo(point.x, point.y);
                
                // Add glow every few points
                if (i % 4 === 0) {
                    ctx.stroke();
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'rgba(255, 107, 139, 0.5)';
                    ctx.beginPath();
                    ctx.moveTo(trail[i-1].x, trail[i-1].y);
                    ctx.lineTo(point.x, point.y);
                }
            }
            
            ctx.shadowBlur = 0;
            ctx.stroke();
        }

        function sliceFruit(x, y) {
            const now = performance.now();
            const isCombo = now - lastSliceTime < comboThreshold;
            lastSliceTime = now;
            
            let sliced = false;
            
            for (let i = 0; i < activeFruits.length; i++) {
                const fruit = activeFruits[i];
                
                if (fruit.isSliced) continue;
                
                // More accurate collision detection
                const dx = x - (fruit.x + fruit.size / 2);
                const dy = y - (fruit.y + fruit.size / 2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < fruit.size * 0.7) {
                    fruit.isSliced = true;
                    fruit.slicedTime = now;
                    fruit.slices.push({ x, y });
                    
                    if (fruit.isBomb) {
                        loseLife();
                        combo = 0;
                    } else {
                        // Update combo
                        if (isCombo) {
                            combo++;
                        } else {
                            combo = 1;
                        }
                        
                        // Calculate points with combo multiplier
                        const basePoints = fruit.points;
                        const comboBonus = Math.min(3, Math.floor(combo / 4));
                        const points = basePoints * (1 + comboBonus * 0.5);
                        score += Math.round(points);
                        scoreElement.textContent = score;
                        
                        // Create floating score text
                        createScoreText(fruit.x + fruit.size / 2, fruit.y + fruit.size / 2, Math.round(points), comboBonus > 0);
                        
                        // Remove fruit after a delay
                        setTimeout(() => {
                            const index = activeFruits.indexOf(fruit);
                            if (index !== -1) {
                                activeFruits.splice(index, 1);
                            }
                        }, 300);
                    }
                    
                    sliced = true;
                }
            }
            
            return sliced;
        }

        function createScoreText(x, y, points, isCombo) {
            if (particles.length < maxParticles) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: -2 - Math.random() * 1.5,
                    text: `+${points}`,
                    color: isCombo ? '#FFD740' : '#FFFFFF',
                    size: 18 + Math.min(10, points),
                    life: 60,
                    maxLife: 60,
                    gravity: 0.03,
                    draw: function(ctx) {
                        ctx.font = `bold ${this.size}px Poppins`;
                        ctx.fillStyle = this.color;
                        ctx.textAlign = 'center';
                        ctx.shadowColor = 'rgba(0,0,0,0.5)';
                        ctx.shadowBlur = 3;
                        ctx.fillText(this.text, this.x, this.y);
                        ctx.shadowBlur = 0;
                        ctx.textAlign = 'left';
                    }
                });
            }
        }

        function loseLife() {
            lives--;
            livesElement.textContent = '❤️'.repeat(Math.max(0, lives));
            
            // Shake effect when losing life
            gameScreen.style.animation = 'shake 0.5s';
            setTimeout(() => {
                gameScreen.style.animation = '';
            }, 500);
            
            // Create explosion effect
            if (lives >= 0 && particles.length < maxParticles - 10) {
                for (let i = 0; i < 10; i++) {
                    particles.push({
                        x: gameCanvas.width / 2,
                        y: 50,
                        vx: (Math.random() - 0.5) * 3,
                        vy: -2 - Math.random() * 2,
                        radius: 2 + Math.random() * 3,
                        color: '#EF476F',
                        gravity: 0.1,
                        life: 40 + Math.random() * 40,
                        maxLife: 80
                    });
                }
            }
            
            if (lives <= 0) {
                endGame();
            }
        }

        function endGame() {
            isGameRunning = false;
            cancelAnimationFrame(gameInterval);
            finalScoreElement.textContent = score;
            updateHighScores();
            showGameOver();
        }

        // Mouse/touch events
        gameCanvas.addEventListener('mousemove', (e) => {
            if (!isGameRunning) return;
            
            const rect = gameCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            trail.push({ x, y });
            if (trail.length > maxTrailLength) {
                trail.shift();
            }
            
            sliceFruit(x, y);
        });

        gameCanvas.addEventListener('touchmove', (e) => {
            if (!isGameRunning) return;
            
            e.preventDefault();
            const rect = gameCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            trail.push({ x, y });
            if (trail.length > maxTrailLength) {
                trail.shift();
            }
            
            sliceFruit(x, y);
        }, { passive: false });

        // Initialize game
        setDifficulty('easy');
        updateHighScoreDisplay();
        showMenu();
    </script>
</body>
</html>
