<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bucket Jump: Marketplace Edition ðŸª£</title>
    <style>
        :root { --neon: #4dd0e1; --accent: #e94560; --bg: #1a1a2e; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; }
        #game-container { position: relative; border: 5px solid var(--neon); border-radius: 20px; box-shadow: 0 0 30px rgba(77, 208, 225, 0.2); }
        canvas { display: block; background: #16213e; border-radius: 15px; cursor: crosshair; }
        
        /* UI Overlays */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 26, 46, 0.95); 
                    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: 15px; }
        .hidden { display: none !important; }
        
        h1 { font-size: 3rem; color: var(--neon); text-shadow: 0 0 10px var(--neon); margin: 0; }
        .btn { background: var(--accent); color: white; border: none; padding: 15px 35px; font-size: 1.2rem; border-radius: 50px; 
               cursor: pointer; margin: 10px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 0 #950740; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #950740; }
        
        /* Shop Styles */
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px; }
        .shop-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 2px solid transparent; text-align: center; width: 120px; }
        .shop-item.owned { border-color: var(--neon); }
        .skin-preview { width: 40px; height: 40px; margin: 0 auto 10px; border-radius: 5px; }
        
        .hud { position: absolute; top: 15px; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; pointer-events: none; font-weight: bold; font-size: 1.2rem; }
        .currency { color: #ffd700; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="hud">
        <div>LEVEL: <span id="lv-ui">1</span></div>
        <div class="currency">ðŸ’§ WATER: <span id="gold-ui">0</span></div>
    </div>

    <div id="menu" class="overlay">
        <h1>BUCKET JUMP</h1>
        <p style="opacity: 0.7">Collect 3 Gold Stars to exit!</p>
        <button class="btn" onclick="startGame()">START GAME</button>
        <button class="btn" style="background:#4ecca3; box-shadow: 0 4px 0 #11998e;" onclick="showShop()">MARKETPLACE</button>
    </div>

    <div id="shop" class="overlay hidden">
        <h1>MARKETPLACE</h1>
        <div class="shop-grid" id="shop-items"></div>
        <button class="btn" onclick="hideShop()">BACK</button>
    </div>

    <canvas id="c" width="850" height="450"></canvas>
</div>

<script>
const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');

// --- GAME DATA & SAVING ---
let state = JSON.parse(localStorage.getItem('bucketJumpSave')) || {
    gold: 0, owned: ['Default'], active: 'Default'
};
function save() { 
    localStorage.setItem('bucketJumpSave', JSON.stringify(state)); 
    document.getElementById('gold-ui').innerText = state.gold;
}

const SKINS = {
    'Default': { color: '#00b0ff', trail: '#00b0ff44', cost: 0 },
    'Lava':    { color: '#ff4d4d', trail: '#ff4d4d44', cost: 50 },
    'Forest':  { color: '#4ecca3', trail: '#4ecca344', cost: 100 },
    'Stealth': { color: '#2d3436', trail: '#636e7244', cost: 200 },
    'Royal':   { color: '#ffd700', trail: '#ffd70044', cost: 500 },
    'Galaxy':  { color: '#6c5ce7', trail: '#a29bfe44', cost: 1000 }
};

// --- AUDIO ---
let ac;
function playSound(f, t, d, v) {
    if(!ac) return;
    let o = ac.createOscillator(), g = ac.createGain();
    o.type = t; o.frequency.setValueAtTime(f, ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(10, ac.currentTime + d);
    g.gain.setValueAtTime(v, ac.currentTime);
    g.gain.linearRampToValueAtTime(0, ac.currentTime + d);
    o.connect(g); g.connect(ac.destination);
    o.start(); o.stop(ac.currentTime + d);
}

// --- ENGINE ---
let player = { x: 100, y: 300, vx: 0, vy: 0, w: 32, h: 32, j: 0, ground: false, trail: [] };
let platforms = [], stars = [], drops = [], level = 1, collectedStars = 0, camX = 0, keys = {};

function initLevel(num) {
    level = num; collectedStars = 0; camX = 0;
    player.x = 100; player.y = 300; player.vx = 0; player.vy = 0;
    platforms = [{x: 0, y: 380, w: 300, h: 70}];
    stars = []; drops = [];
    
    let cx = 400;
    for(let i=0; i < 8+num; i++) {
        let w = 80 + Math.random()*100, y = 180 + Math.random()*180;
        platforms.push({ x: cx, y: y, w: w, h: 25 });
        if(i % 2 === 0) stars.push({ x: cx + w/2, y: y-40, off: Math.random()*10 });
        drops.push({ x: cx + Math.random()*w, y: y-80, off: Math.random()*10 });
        cx += w + 80 + Math.random()*60;
    }
    platforms.push({ x: cx, y: 350, w: 200, h: 100, goal: true });
    document.getElementById('lv-ui').innerText = level;
    save();
}

function update() {
    if(keys['KeyA']) player.vx -= 0.7;
    if(keys['KeyD']) player.vx += 0.7;
    player.vx *= 0.88; player.vy += 0.6;
    player.x += player.vx; player.y += player.vy;
    player.ground = false;

    // Trail logic
    player.trail.push({x: player.x, y: player.y});
    if(player.trail.length > 8) player.trail.shift();

    platforms.forEach(p => {
        if(player.x+player.w > p.x && player.x < p.x+p.w && player.y+player.h > p.y && player.y < p.y+p.h) {
            if(player.vy > 0) {
                player.y = p.y - player.h; player.vy = 0; player.ground = true; player.j = 0;
                if(p.goal && collectedStars >= 3) { playSound(600, 'sine', 0.4, 0.1); initLevel(level+1); }
            }
        }
    });

    stars.forEach((s, i) => {
        if(!s.done && Math.hypot(player.x-s.x, player.y-s.y) < 40) {
            s.done = true; collectedStars++; playSound(800, 'square', 0.1, 0.1);
        }
    });

    drops.forEach((d, i) => {
        if(!d.done && Math.hypot(player.x-d.x, player.y-d.y) < 40) {
            d.done = true; state.gold += 5; save(); playSound(1200, 'sine', 0.05, 0.05);
        }
    });

    if(player.y > 500) { playSound(100, 'sawtooth', 0.3, 0.2); initLevel(level); }
    camX += (player.x - camX - 250) * 0.1;
}

function render() {
    ctx.clearRect(0,0,850,450);
    ctx.save(); ctx.translate(-camX, 0);

    const skin = SKINS[state.active];

    // Platforms
    platforms.forEach(p => {
        ctx.fillStyle = p.goal ? (collectedStars >= 3 ? '#ffd700' : '#444') : '#4dd0e1';
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(p.x, p.y, p.w, 4);
    });

    // Trail
    player.trail.forEach((t, i) => {
        ctx.globalAlpha = i/10; ctx.fillStyle = skin.color;
        ctx.fillRect(t.x, t.y, player.w, player.h);
    });
    ctx.globalAlpha = 1;

    // Items
    stars.forEach(s => { if(!s.done) { ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(s.x, s.y + Math.sin(Date.now()/200)*5, 10, 0, 7); ctx.fill(); }});
    drops.forEach(d => { if(!d.done) { ctx.fillStyle = '#00b0ff'; ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(d.x+6, d.y+12); ctx.lineTo(d.x-6, d.y+12); ctx.fill(); }});

    // Player
    ctx.fillStyle = skin.color;
    ctx.fillRect(player.x, player.y, player.w, player.h);
    ctx.fillStyle = 'white'; ctx.fillRect(player.x+6, player.y+6, 6, 6); ctx.fillRect(player.x+20, player.y+6, 6, 6);

    ctx.restore();
    update();
    requestAnimationFrame(render);
}

// --- UI LOGIC ---
function startGame() {
    if(!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('menu').classList.add('hidden');
    initLevel(1); render();
}

function showShop() {
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('shop').classList.remove('hidden');
    const container = document.getElementById('shop-items');
    container.innerHTML = '';
    
    for(let name in SKINS) {
        const s = SKINS[name];
        const owned = state.owned.includes(name);
        const active = state.active === name;
        
        const div = document.createElement('div');
        div.className = `shop-item ${active ? 'owned' : ''}`;
        div.innerHTML = `
            <div class="skin-preview" style="background:${s.color}"></div>
            <div style="font-size:0.8rem">${name}</div>
            <button class="btn" style="padding:5px 10px; font-size:0.7rem; width:100%" 
                onclick="handleBuy('${name}')">
                ${owned ? (active ? 'EQUIPPED' : 'SELECT') : 'ðŸ’§' + s.cost}
            </button>
        `;
        container.appendChild(div);
    }
}

function handleBuy(name) {
    const s = SKINS[name];
    if(state.owned.includes(name)) {
        state.active = name;
    } else if(state.gold >= s.cost) {
        state.gold -= s.cost;
        state.owned.push(name);
        state.active = name;
        playSound(900, 'sine', 0.2, 0.1);
    }
    save(); showShop();
}

function hideShop() { 
    document.getElementById('shop').classList.add('hidden'); 
    document.getElementById('menu').classList.remove('hidden'); 
}

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;
window.addEventListener('keydown', e => {
    if(e.code === 'Space' && (player.ground || player.j < 1)) {
        player.vy = -13; player.ground = false; player.j++;
        playSound(400, 'sine', 0.1, 0.1);
    }
});

save(); // Initial HUD sync
</script>
</body>
</html>
