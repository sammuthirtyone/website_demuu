<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sugar Rush: 300 Levels</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        :root {
            --primary: #ff4081;
            --secondary: #00e5ff;
            --glass: rgba(255, 255, 255, 0.9);
            --tile-size: 45px;
            --gap: 4px;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-image: radial-gradient(circle at 10% 20%, rgb(255, 197, 218) 0%, rgb(255, 120, 189) 90.1%);
            font-family: 'Fredoka One', cursive;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- Screens & UI --- */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
            z-index: 1;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 10;
        }

        .panel {
            background: var(--glass);
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2), inset 0 0 0 5px rgba(255,255,255,0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            animation: float 4s ease-in-out infinite;
        }

        h1 {
            font-size: 3rem;
            background: -webkit-linear-gradient(#ff00cc, #333399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            filter: drop-shadow(2px 2px 0px #fff);
        }

        .btn {
            background: linear-gradient(to bottom, #ffeb3b, #ffc107);
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-size: 1.5rem;
            color: #d32f2f;
            font-family: inherit;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 6px 0 #c69403, 0 10px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #c69403; }
        .btn-pink { background: linear-gradient(to bottom, #ff80ab, #f50057); color: white; box-shadow: 0 6px 0 #ad003d; }
        .btn-pink:active { box-shadow: 0 2px 0 #ad003d; }
        .btn-icon { padding: 10px; width: 60px; height: 60px; border-radius: 50%; font-size: 1.8rem; }

        /* --- Level Select Styles (Scrollable) --- */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            padding: 10px;
            
            /* SCROLLABLE MAGIC HERE */
            max-height: 250px; /* Shows about 3 rows */
            overflow-y: auto;  /* Enable vertical scroll */
            
            /* Cute Scrollbar Styling */
            scrollbar-width: thin;
            scrollbar-color: #ff80ab rgba(0,0,0,0.05);
        }

        /* Webkit Scrollbar (Chrome/Safari) */
        .level-grid::-webkit-scrollbar {
            width: 8px;
        }
        .level-grid::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }
        .level-grid::-webkit-scrollbar-thumb {
            background: #ff80ab;
            border-radius: 10px;
        }

        .level-btn {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            border: none;
            font-family: inherit;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            background: linear-gradient(to bottom, #00e5ff, #00b0ff);
            box-shadow: 0 5px 0 #0081cb, 0 5px 10px rgba(0,0,0,0.2);
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin: 0 auto; /* Centers in grid cell */
        }

        .level-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #0081cb; }
        
        .level-btn.locked {
            background: #e0e0e0;
            color: #999;
            box-shadow: 0 5px 0 #bdbdbd;
            cursor: not-allowed;
        }
        .level-btn.locked:active { transform: none; }

        /* --- Game Board --- */
        .header-stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .stat div:first-child { font-size: 0.8rem; color: #888; }
        .stat div:last-child { font-size: 1.4rem; color: #333; }

        #board-container {
            position: relative;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            padding: 10px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1);
        }

        .grid {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto;
        }

        .tile {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 0; top: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
            touch-action: none; 
        }

        .tile.selected { z-index: 20; }
        .tile.selected::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            animation: pulse 0.8s infinite;
        }
        .tile.hint { animation: shake 2s infinite; filter: brightness(1.3); }

        /* Particles */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: pop 0.6s ease-out forwards;
        }

        /* --- Shop Items --- */
        .shop-item {
            display: flex;
            align-items: center;
            background: #fff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .shop-item:hover { border-color: gold; transform: scale(1.02); }
        .shop-price { background: #ffd700; color: #8a6e02; padding: 5px 10px; border-radius: 10px; font-size: 0.9rem; }

        /* --- Animations --- */
        @keyframes pulse { 0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(0.9); } }
        @keyframes pop { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        
        .floater {
            position: absolute;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s forwards;
            z-index: 100;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

        .mode-active { cursor: crosshair !important; border: 4px solid red; }

    </style>
</head>
<body>

    <div style="position:absolute; top:10px; right:10px; z-index:100;">
        <button id="btn-sound" class="btn btn-icon" style="width:40px; height:40px; font-size:1.2rem; padding:0;" onclick="audioSys.toggle()">üîá</button>
    </div>

    <div id="screen-home" class="screen active">
        <div class="panel">
            <h1>Jelly<br>Pop</h1>
            <p>Ultimate Edition</p>
            <button class="btn" onclick="ui.nav('screen-levels')">PLAY</button>
            <button class="btn btn-pink" onclick="ui.nav('screen-shop')">SHOP</button>
        </div>
    </div>

    <div id="screen-levels" class="screen">
        <div class="panel">
            <h2>Select Level</h2>
            
            <div id="level-container" class="level-grid">
                </div>
            
            <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                Scroll for more üëá
            </div>

            <button class="btn btn-pink" onclick="ui.nav('screen-home')" style="font-size:1rem; padding:10px 30px;">Back Home</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="panel" style="width: 100%; max-width: 380px; padding: 10px; background: rgba(255,255,255,0.7);">
            <div class="header-stats">
                <div class="stat"><div>LVL</div><div id="ui-lvl-num">1</div></div>
                <div class="stat"><div>MOVES</div><div id="ui-moves">20</div></div>
                <div class="stat"><div>TARGET</div><div id="ui-target">1000</div></div>
                <div class="stat"><div>SCORE</div><div id="ui-score">0</div></div>
            </div>
            
            <div style="width:100%; height:10px; background:#ddd; border-radius:5px; margin-bottom:10px; overflow:hidden;">
                <div id="score-bar" style="height:100%; width:0%; background:#00e5ff; transition:width 0.5s;"></div>
            </div>

            <div id="board-container">
                <div id="grid" class="grid"></div>
            </div>

            <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <button class="btn btn-pink btn-icon" id="btn-hammer" onclick="powerups.activate('hammer')">üî®</button>
                <button class="btn btn-pink btn-icon" id="btn-bomb" onclick="powerups.activate('bomb')">üí£</button>
                <button class="btn btn-pink btn-icon" id="btn-shuffle" onclick="powerups.activate('shuffle')">üîÑ</button>
            </div>
            <button style="margin-top:5px; background:transparent; border:none; color:#666;" onclick="game.gameOver(false)">Give Up</button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="panel">
            <h2>Market</h2>
            <div style="margin-bottom:10px;">Coins: <span id="shop-coins" style="color:#e6b800; font-size:1.5rem;">0</span></div>
            
            <div class="shop-item" onclick="market.buy('hammer')">
                <div style="font-size:2rem; margin-right:10px;">üî®</div>
                <div style="text-align:left; flex:1">
                    <div>Smash</div>
                    <div style="font-size:0.7rem; color:#888;">Destroy 1 candy</div>
                </div>
                <div class="shop-price">450</div>
            </div>

            <div class="shop-item" onclick="market.buy('bomb')">
                <div style="font-size:2rem; margin-right:10px;">üí£</div>
                <div style="text-align:left; flex:1">
                    <div>Bomb</div>
                    <div style="font-size:0.7rem; color:#888;">Destroy 3x3 area</div>
                </div>
                <div class="shop-price">999</div>
            </div>

            <div class="shop-item" onclick="market.buy('shuffle')">
                <div style="font-size:2rem; margin-right:10px;">üîÑ</div>
                <div style="text-align:left; flex:1">
                    <div>Shuffle</div>
                    <div style="font-size:0.7rem; color:#888;">Mix the board</div>
                </div>
                <div class="shop-price">350</div>
            </div>

            <div id="shop-msg" style="height:20px; color:red; font-size:0.8rem;"></div>
            <button class="btn" onclick="ui.nav('screen-home')">Back</button>
        </div>
    </div>

    <div id="screen-result" class="screen" style="z-index:20; background:rgba(0,0,0,0.8);">
        <div class="panel">
            <h1 id="res-title">Won!</h1>
            <div id="res-stars" style="font-size:3rem;">‚≠ê‚≠ê‚≠ê</div>
            <p id="res-msg">Score: 5000</p>
            <div id="res-btns">
                <button class="btn" onclick="ui.nav('screen-levels')">Levels</button>
            </div>
        </div>
    </div>

    <script>
        // --- LEVEL CONFIGURATION (15 LEVELS) ---
        const levels = [
            { id: 1, moves: 15, target: 500,  reward: 50 },
            { id: 2, moves: 20, target: 1200, reward: 75 },
            { id: 3, moves: 25, target: 2000, reward: 100 },
            { id: 4, moves: 35, target: 3500, reward: 150 },
            { id: 5, moves: 40, target: 5000, reward: 200 },
            { id: 6, moves: 45, target: 8000, reward: 250 },
            // NEW LEVELS 7-12
            { id: 7, moves: 40, target: 4500, reward: 300 }, // Speed Round
            { id: 8, moves: 75, target: 9000, reward: 350 },
            { id: 9, moves: 90, target: 11000, reward: 400 },
            { id: 10, moves: 140, target: 14000, reward: 450 },
            { id: 11, moves: 125, target: 8000, reward: 500 }, // High Difficulty
            { id: 12, moves: 170, target: 20000, reward: 1000 }, // Ultimate Boss
            { id: 13, moves: 200, target: 20500, reward: 1100 },
            { id: 14, moves: 290, target: 21000, reward: 1300 },
            { id: 15, moves: 310, target: 30000, reward: 1500 },
            { id: 16, moves: 480, target: 31000, reward: 2000 },
            { id: 17, moves: 450, target: 33000, reward: 1000 },
            { id: 18, moves: 460, target: 34500, reward: 2600 },
            { id: 19, moves: 462, target: 34800, reward: 2650 },
            { id: 20, moves: 464, target: 35100, reward: 2700 },
            { id: 21, moves: 466, target: 35400, reward: 2750 },
            { id: 22, moves: 468, target: 35700, reward: 2800 },
            { id: 23, moves: 470, target: 36000, reward: 2850 },
            { id: 24, moves: 472, target: 36300, reward: 2900 },
            { id: 25, moves: 474, target: 36600, reward: 2950 },
            { id: 26, moves: 476, target: 36900, reward: 3000 },
            { id: 27, moves: 478, target: 37200, reward: 3050 },
            { id: 28, moves: 480, target: 37500, reward: 3100 },
            { id: 29, moves: 482, target: 37800, reward: 3150 },
            { id: 30, moves: 484, target: 38100, reward: 3200 },
            { id: 31, moves: 486, target: 38400, reward: 3250 },
            { id: 32, moves: 488, target: 38700, reward: 3300 },
            { id: 33, moves: 490, target: 39000, reward: 3350 },
            { id: 34, moves: 592, target: 39300, reward: 3400 },
            { id: 35, moves: 594, target: 39600, reward: 3450 },
            { id: 36, moves: 596, target: 39900, reward: 3500 },
            { id: 37, moves: 598, target: 40200, reward: 3550 },
            { id: 38, moves: 500, target: 40500, reward: 3600 },
            { id: 39, moves: 502, target: 40800, reward: 3650 },
            { id: 40, moves: 504, target: 41100, reward: 3700 },
            { id: 41, moves: 506, target: 41400, reward: 3750 },
            { id: 42, moves: 508, target: 41700, reward: 3800 },
            { id: 43, moves: 510, target: 42000, reward: 3850 },
            { id: 44, moves: 512, target: 42300, reward: 3900 },
            { id: 45, moves: 514, target: 42600, reward: 3950 },
            { id: 46, moves: 516, target: 42900, reward: 4000 },
            { id: 47, moves: 518, target: 43200, reward: 4050 },
            { id: 48, moves: 520, target: 43500, reward: 4100 },
            { id: 49, moves: 522, target: 43800, reward: 4150 },
            { id: 50, moves: 524, target: 44100, reward: 4200 },
            { id: 51, moves: 526, target: 44135, reward: 4250 },
            { id: 52, moves: 528, target: 44170, reward: 4300 },
            { id: 53, moves: 530, target: 44205, reward: 4350 },
            { id: 54, moves: 532, target: 44240, reward: 4400 },
            { id: 55, moves: 534, target: 44275, reward: 4450 },
            { id: 56, moves: 536, target: 44310, reward: 4500 },
            { id: 57, moves: 538, target: 44345, reward: 4550 },
            { id: 58, moves: 540, target: 44380, reward: 4600 },
            { id: 59, moves: 542, target: 44415, reward: 4650 },
            { id: 60, moves: 544, target: 44450, reward: 4700 },
            { id: 61, moves: 546, target: 44485, reward: 4750 },
            { id: 62, moves: 548, target: 44520, reward: 4800 },
            { id: 63, moves: 550, target: 44555, reward: 4850 },
            { id: 64, moves: 552, target: 44590, reward: 4900 },
            { id: 65, moves: 554, target: 44625, reward: 4950 },
            { id: 66, moves: 556, target: 44660, reward: 5000 },
            { id: 67, moves: 558, target: 44695, reward: 5050 },
            { id: 68, moves: 560, target: 44730, reward: 5100 },
            { id: 69, moves: 562, target: 44765, reward: 5150 },
            { id: 70, moves: 564, target: 44800, reward: 5200 },
            { id: 71, moves: 566, target: 44835, reward: 5250 },
            { id: 72, moves: 568, target: 44870, reward: 5300 },
            { id: 73, moves: 570, target: 44905, reward: 5350 },
            { id: 74, moves: 572, target: 44940, reward: 5400 },
            { id: 75, moves: 574, target: 44975, reward: 5450 },
            { id: 76, moves: 576, target: 45010, reward: 5500 },
            { id: 77, moves: 578, target: 45045, reward: 5550 },
            { id: 78, moves: 580, target: 45080, reward: 5600 },
            { id: 79, moves: 582, target: 45115, reward: 5650 },
            { id: 80, moves: 584, target: 45150, reward: 5700 },
            { id: 81, moves: 586, target: 45185, reward: 5750 },
            { id: 82, moves: 588, target: 45220, reward: 5800 },
            { id: 83, moves: 590, target: 45255, reward: 5850 },
            { id: 84, moves: 592, target: 45290, reward: 5900 },
            { id: 85, moves: 594, target: 45325, reward: 5950 },
            { id: 86, moves: 596, target: 45360, reward: 6000 },
            { id: 87, moves: 598, target: 45395, reward: 6050 },
            { id: 88, moves: 600, target: 45430, reward: 6100 },
            { id: 89, moves: 602, target: 45465, reward: 6150 },
            { id: 90, moves: 604, target: 45500, reward: 6200 },
            { id: 91, moves: 606, target: 45535, reward: 6250 },
            { id: 92, moves: 608, target: 45570, reward: 6300 },
            { id: 93, moves: 610, target: 45605, reward: 6350 },
            { id: 94, moves: 612, target: 45640, reward: 6400 },
            { id: 95, moves: 614, target: 45675, reward: 6450 },
            { id: 96, moves: 616, target: 45710, reward: 6500 },
            { id: 97, moves: 618, target: 45745, reward: 6550 },
            { id: 98, moves: 620, target: 45780, reward: 6600 },
            { id: 99, moves: 622, target: 45815, reward: 6650 },
            { id: 100, moves: 624, target: 45850, reward: 6700 },
            { id: 101, moves: 626, target: 45885, reward: 6750 },
            { id: 102, moves: 628, target: 45920, reward: 6800 },
            { id: 103, moves: 630, target: 45955, reward: 6850 },
            { id: 104, moves: 632, target: 45990, reward: 6900 },
            { id: 105, moves: 634, target: 46025, reward: 6950 },
            { id: 106, moves: 636, target: 46060, reward: 7000 },
            { id: 107, moves: 638, target: 46095, reward: 7050 },
            { id: 108, moves: 640, target: 46130, reward: 7100 },
            { id: 109, moves: 642, target: 46165, reward: 7150 },
            { id: 110, moves: 644, target: 46200, reward: 7200 },
            { id: 111, moves: 646, target: 46235, reward: 7250 },
            { id: 112, moves: 648, target: 46270, reward: 7300 },
            { id: 113, moves: 650, target: 46305, reward: 7350 },
            { id: 114, moves: 652, target: 46340, reward: 7400 },
            { id: 115, moves: 654, target: 46375, reward: 7450 },
            { id: 116, moves: 656, target: 46410, reward: 7500 },
            { id: 117, moves: 658, target: 46445, reward: 7550 },
            { id: 118, moves: 660, target: 46480, reward: 7600 },
            { id: 119, moves: 662, target: 46515, reward: 7650 },
            { id: 120, moves: 664, target: 46550, reward: 7700 },
            { id: 121, moves: 666, target: 46585, reward: 7750 },
            { id: 122, moves: 668, target: 46620, reward: 7800 },
            { id: 123, moves: 670, target: 46655, reward: 7850 },
            { id: 124, moves: 672, target: 46690, reward: 7900 },
            { id: 125, moves: 674, target: 46725, reward: 7950 },
            { id: 126, moves: 676, target: 46760, reward: 8000 },
            { id: 127, moves: 678, target: 46795, reward: 8050 },
            { id: 128, moves: 680, target: 46830, reward: 8100 },
            { id: 129, moves: 682, target: 46865, reward: 8150 },
            { id: 130, moves: 684, target: 46900, reward: 8200 },
            { id: 131, moves: 686, target: 46935, reward: 8250 },
            { id: 132, moves: 688, target: 46970, reward: 8300 },
            { id: 133, moves: 690, target: 47005, reward: 8350 },
            { id: 134, moves: 692, target: 47040, reward: 8400 },
            { id: 135, moves: 694, target: 47075, reward: 8450 },
            { id: 136, moves: 696, target: 47110, reward: 8500 },
            { id: 137, moves: 698, target: 47145, reward: 8550 },
            { id: 138, moves: 700, target: 47180, reward: 8600 },
            { id: 139, moves: 702, target: 47215, reward: 8650 },
            { id: 140, moves: 704, target: 47250, reward: 8700 },
            { id: 141, moves: 706, target: 47285, reward: 8750 },
            { id: 142, moves: 708, target: 47320, reward: 8800 },
            { id: 143, moves: 710, target: 47355, reward: 8850 },
            { id: 144, moves: 712, target: 47390, reward: 8900 },
            { id: 145, moves: 714, target: 47425, reward: 8950 },
            { id: 146, moves: 716, target: 47460, reward: 9000 },
            { id: 147, moves: 718, target: 47495, reward: 9050 },
            { id: 148, moves: 720, target: 47530, reward: 9100 },
            { id: 149, moves: 722, target: 47565, reward: 9150 },
            { id: 150, moves: 724, target: 47600, reward: 9200 },
            { id: 151, moves: 726, target: 47635, reward: 9250 },
            { id: 152, moves: 728, target: 47670, reward: 9300 },
            { id: 153, moves: 730, target: 47705, reward: 9350 },
            { id: 154, moves: 732, target: 47740, reward: 9400 },
            { id: 155, moves: 734, target: 47775, reward: 9450 },
            { id: 156, moves: 736, target: 47810, reward: 9500 },
            { id: 157, moves: 738, target: 47845, reward: 9550 },
            { id: 158, moves: 740, target: 47880, reward: 9600 },
            { id: 159, moves: 742, target: 47915, reward: 9650 },
            { id: 160, moves: 744, target: 47950, reward: 9700 },
            { id: 161, moves: 746, target: 47985, reward: 9750 },
            { id: 162, moves: 748, target: 48020, reward: 9800 },
            { id: 163, moves: 750, target: 48055, reward: 9850 },
            { id: 164, moves: 752, target: 48090, reward: 9900 },
            { id: 165, moves: 754, target: 48125, reward: 9950 },
            { id: 166, moves: 756, target: 48160, reward: 10000 },
            { id: 167, moves: 758, target: 48195, reward: 10050 },
            { id: 168, moves: 760, target: 48230, reward: 10100 },
            { id: 169, moves: 762, target: 48265, reward: 10150 },
            { id: 170, moves: 764, target: 48300, reward: 10200 },
            { id: 171, moves: 766, target: 48335, reward: 10250 },
            { id: 172, moves: 768, target: 48370, reward: 10300 },
            { id: 173, moves: 770, target: 48405, reward: 10350 },
            { id: 174, moves: 772, target: 48440, reward: 10400 },
            { id: 175, moves: 774, target: 48475, reward: 10450 },
            { id: 176, moves: 776, target: 48510, reward: 10500 },
            { id: 177, moves: 778, target: 48545, reward: 10550 },
            { id: 178, moves: 780, target: 48580, reward: 10600 },
            { id: 179, moves: 782, target: 48615, reward: 10650 },
            { id: 180, moves: 784, target: 48650, reward: 10700 },
            { id: 181, moves: 786, target: 48685, reward: 10750 },
            { id: 182, moves: 788, target: 48720, reward: 10800 },
            { id: 183, moves: 790, target: 48755, reward: 10850 },
            { id: 184, moves: 792, target: 48790, reward: 10900 },
            { id: 185, moves: 794, target: 48825, reward: 10950 },
            { id: 186, moves: 796, target: 48860, reward: 11000 },
            { id: 187, moves: 798, target: 48895, reward: 11050 },
            { id: 188, moves: 800, target: 48930, reward: 11100 },
            { id: 189, moves: 802, target: 48965, reward: 11150 },
            { id: 190, moves: 804, target: 49000, reward: 11200 },
            { id: 191, moves: 806, target: 49035, reward: 11250 },
            { id: 192, moves: 808, target: 49070, reward: 11300 },
            { id: 193, moves: 810, target: 49105, reward: 11350 },
            { id: 194, moves: 812, target: 49140, reward: 11400 },
            { id: 195, moves: 814, target: 49175, reward: 11450 },
            { id: 196, moves: 816, target: 49210, reward: 11500 },
            { id: 197, moves: 818, target: 49245, reward: 11550 },
            { id: 198, moves: 820, target: 49280, reward: 11600 },
            { id: 199, moves: 822, target: 49315, reward: 11650 },
            { id: 200, moves: 824, target: 49350, reward: 11700 },
            { id: 201, moves: 826, target: 49385, reward: 11750 },
            { id: 202, moves: 828, target: 49420, reward: 11800 },
            { id: 203, moves: 830, target: 49455, reward: 11850 },
            { id: 204, moves: 832, target: 49490, reward: 11900 },
            { id: 205, moves: 834, target: 49525, reward: 11950 },
            { id: 206, moves: 836, target: 49560, reward: 12000 },
            { id: 207, moves: 838, target: 49595, reward: 12050 },
            { id: 208, moves: 840, target: 49630, reward: 12100 },
            { id: 209, moves: 842, target: 49665, reward: 12150 },
            { id: 210, moves: 844, target: 49700, reward: 12200 },
            { id: 211, moves: 846, target: 49735, reward: 12250 },
            { id: 212, moves: 848, target: 49770, reward: 12300 },
            { id: 213, moves: 850, target: 49805, reward: 12350 },
            { id: 214, moves: 852, target: 49840, reward: 12400 },
            { id: 215, moves: 854, target: 49875, reward: 12450 },
            { id: 216, moves: 856, target: 49910, reward: 12500 },
            { id: 217, moves: 858, target: 49945, reward: 12550 },
            { id: 218, moves: 860, target: 49980, reward: 12600 },
            { id: 219, moves: 862, target: 50015, reward: 12650 },
            { id: 220, moves: 864, target: 50050, reward: 12700 },
            { id: 221, moves: 866, target: 50085, reward: 12750 },
            { id: 222, moves: 868, target: 50120, reward: 12800 },
            { id: 223, moves: 870, target: 50155, reward: 12850 },
            { id: 224, moves: 872, target: 50190, reward: 12900 },
            { id: 225, moves: 874, target: 50225, reward: 12950 },
            { id: 226, moves: 876, target: 50260, reward: 13000 },
            { id: 227, moves: 878, target: 50295, reward: 13050 },
            { id: 228, moves: 880, target: 50330, reward: 13100 },
            { id: 229, moves: 882, target: 50365, reward: 13150 },
            { id: 230, moves: 884, target: 50400, reward: 13200 },
            { id: 231, moves: 886, target: 50435, reward: 13250 },
            { id: 232, moves: 888, target: 50470, reward: 13300 },
            { id: 233, moves: 890, target: 50505, reward: 13350 },
            { id: 234, moves: 892, target: 50540, reward: 13400 },
            { id: 235, moves: 894, target: 50575, reward: 13450 },
            { id: 236, moves: 896, target: 50610, reward: 13500 },
            { id: 237, moves: 898, target: 50645, reward: 13550 },
            { id: 238, moves: 900, target: 50680, reward: 13600 },
            { id: 239, moves: 902, target: 50715, reward: 13650 },
            { id: 240, moves: 904, target: 50750, reward: 13700 },

            { id: 241, moves: 906, target: 50785, reward: 13750 },
            { id: 242, moves: 908, target: 50820, reward: 13800 },
            { id: 243, moves: 910, target: 50855, reward: 13850 },
            { id: 244, moves: 912, target: 50890, reward: 13900 },
            { id: 245, moves: 914, target: 50925, reward: 13950 },
            { id: 246, moves: 916, target: 50960, reward: 14000 },
            { id: 247, moves: 918, target: 50995, reward: 14050 },
            { id: 248, moves: 920, target: 51030, reward: 14100 },
            { id: 249, moves: 922, target: 51065, reward: 14150 },
            { id: 250, moves: 924, target: 51100, reward: 14200 },
            { id: 251, moves: 926, target: 51135, reward: 14250 },
            { id: 252, moves: 928, target: 51170, reward: 14300 },
            { id: 253, moves: 930, target: 51205, reward: 14350 },
            { id: 254, moves: 932, target: 51240, reward: 14400 },
            { id: 255, moves: 934, target: 51275, reward: 14450 },
            { id: 256, moves: 936, target: 51310, reward: 14500 },
            { id: 257, moves: 938, target: 51345, reward: 14550 },
            { id: 258, moves: 940, target: 51380, reward: 14600 },
            { id: 259, moves: 942, target: 51415, reward: 14650 },
            { id: 260, moves: 944, target: 51450, reward: 14700 },

            { id: 261, moves: 946, target: 51485, reward: 14750 },
            { id: 262, moves: 948, target: 51520, reward: 14800 },
            { id: 263, moves: 950, target: 51555, reward: 14850 },
            { id: 264, moves: 952, target: 51590, reward: 14900 },
            { id: 265, moves: 954, target: 51625, reward: 14950 },
            { id: 266, moves: 956, target: 51660, reward: 15000 },
            { id: 267, moves: 958, target: 51695, reward: 15050 },
            { id: 268, moves: 960, target: 51730, reward: 15100 },
            { id: 269, moves: 962, target: 51765, reward: 15150 },
            { id: 270, moves: 964, target: 51800, reward: 15200 },

            { id: 271, moves: 966, target: 51835, reward: 15250 },
            { id: 272, moves: 968, target: 51870, reward: 15300 },
            { id: 273, moves: 970, target: 51905, reward: 15350 },
            { id: 274, moves: 972, target: 51940, reward: 15400 },
            { id: 275, moves: 974, target: 51975, reward: 15450 },
            { id: 276, moves: 976, target: 52010, reward: 15500 },
            { id: 277, moves: 978, target: 52045, reward: 15550 },
            { id: 278, moves: 980, target: 52080, reward: 15600 },
            { id: 279, moves: 982, target: 52115, reward: 15650 },
            { id: 280, moves: 984, target: 52150, reward: 15700 },

            { id: 281, moves: 986, target: 52185, reward: 15750 },
            { id: 282, moves: 988, target: 52220, reward: 15800 },
            { id: 283, moves: 990, target: 52255, reward: 15850 },
            { id: 284, moves: 992, target: 52290, reward: 15900 },
            { id: 285, moves: 994, target: 52325, reward: 15950 },
            { id: 286, moves: 996, target: 52360, reward: 16000 },
            { id: 287, moves: 998, target: 52395, reward: 16050 },
            { id: 288, moves: 1000, target: 52430, reward: 16100 },
            { id: 289, moves: 1002, target: 52465, reward: 16150 },
            { id: 290, moves: 1004, target: 52500, reward: 16200 },

            { id: 291, moves: 1006, target: 52535, reward: 16250 },
            { id: 292, moves: 1008, target: 52570, reward: 16300 },
            { id: 293, moves: 1010, target: 52605, reward: 16350 },
            { id: 294, moves: 1012, target: 52640, reward: 16400 },
            { id: 295, moves: 1014, target: 52675, reward: 16450 },
            { id: 296, moves: 1016, target: 52710, reward: 16500 },
            { id: 297, moves: 1018, target: 52745, reward: 16550 },
            { id: 298, moves: 1020, target: 52780, reward: 16600 },
            { id: 299, moves: 1022, target: 52815, reward: 16650 },
            { id: 300, moves: 1024, target: 52850, reward: 16700 },
            


        ];

        const audioSys = {
            ctx: null,
            bgmOsc: [],
            isMuted: true,
            isPlaying: false,

            init() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },

            toggle() {
                this.init();
                this.isMuted = !this.isMuted;
                document.getElementById('btn-sound').innerText = this.isMuted ? 'üîá' : 'üîä';
                if(!this.isMuted && !this.isPlaying) this.playMusic();
                if(this.isMuted) this.stopMusic();
            },

            playNote(freq, type, dur, vol=0.1) {
                if(this.isMuted) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + dur);
            },

            sfx(name) {
                if(this.isMuted) return;
                switch(name) {
                    case 'swap': this.playNote(400, 'sine', 0.1); break;
                    case 'match': 
                        this.playNote(600, 'triangle', 0.1); 
                        setTimeout(()=>this.playNote(800, 'triangle', 0.1), 100);
                        break;
                    case 'bad': this.playNote(150, 'sawtooth', 0.3); break;
                    case 'win': 
                        [0, 0.2, 0.4].forEach((t, i) => setTimeout(() => this.playNote(500 + i*200, 'square', 0.3), t*1000));
                        break;
                }
            },

            playMusic() {
                if(this.isMuted || this.isPlaying) return;
                this.isPlaying = true;
                let note = 0;
                const melody = [392, 523, 659, 783, 659, 523]; 
                const interval = setInterval(() => {
                    if(this.isMuted) { clearInterval(interval); this.isPlaying = false; return; }
                    this.playNote(melody[note % melody.length], 'sine', 0.5, 0.05);
                    note++;
                }, 400);
            },
            stopMusic() {
                this.isPlaying = false;
            }
        };

        const cfg = { w: 8, h: 8, size: 40 };
        const emojis = ['üçá', 'üçä', 'ü••', 'üç≠', 'üßÅ', 'üç©','üç´','üç¨']; 
        
        let grid = []; 
        let domGrid = []; 
        let state = {
            selected: null,
            locked: false,
            score: 0,
            moves: 0,
            target: 0,
            levelIdx: 0, 
            maxUnlocked: 1, // Start with only level 1
            inventory: { hammer: 1, bomb: 0, shuffle: 1 },
            coins: 100,
            activeTool: null
        };
        
        let hintTimer = null;

        const ui = {
            nav(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if(id === 'screen-shop') this.updateShop();
                if(id === 'screen-levels') this.buildLevelSelect();
            },
            buildLevelSelect() {
                const con = document.getElementById('level-container');
                con.innerHTML = '';
                levels.forEach((lvl, idx) => {
                    const btn = document.createElement('button');
                    const isLocked = (idx + 1) > state.maxUnlocked;
                    
                    btn.className = `level-btn ${isLocked ? 'locked' : ''}`;
                    btn.innerHTML = isLocked ? 'üîí' : (idx + 1);
                    
                    if(!isLocked) {
                        btn.onclick = () => game.startLevel(idx);
                    }
                    con.appendChild(btn);
                });
            },
            updateStats() {
                document.getElementById('ui-lvl-num').innerText = state.levelIdx + 1;
                document.getElementById('ui-score').innerText = state.score;
                document.getElementById('ui-moves').innerText = state.moves;
                const pct = Math.min(100, (state.score / state.target) * 100);
                document.getElementById('score-bar').style.width = pct + '%';
                document.getElementById('ui-target').innerText = state.target;
            },
            updateShop() {
                document.getElementById('shop-coins').innerText = state.coins;
                document.getElementById('btn-hammer').innerHTML = `üî® <span style="font-size:0.6rem">${state.inventory.hammer}</span>`;
                document.getElementById('btn-bomb').innerHTML = `üí£ <span style="font-size:0.6rem">${state.inventory.bomb}</span>`;
                document.getElementById('btn-shuffle').innerHTML = `üîÑ <span style="font-size:0.6rem">${state.inventory.shuffle}</span>`;
            }
        };

        const game = {
            startLevel(idx) {
                state.levelIdx = idx;
                const config = levels[idx];
                state.moves = config.moves;
                state.target = config.target;
                state.score = 0;
                
                this.init();
            },

            init() {
                state.locked = false;
                state.activeTool = null;
                audioSys.init();
                audioSys.playMusic();
                
                ui.nav('screen-game');
                this.buildGrid();
                ui.updateStats();
                ui.updateShop();
                this.resetHint();
            },

            buildGrid() {
                const con = document.getElementById('grid');
                con.innerHTML = '';
                grid = [];
                domGrid = [];

                for(let r=0; r<cfg.h; r++) {
                    let row = [], dRow = [];
                    for(let c=0; c<cfg.w; c++) {
                        let type;
                        do {
                            type = Math.floor(Math.random() * emojis.length);
                        } while(
                            (r>=2 && grid[r-1][c]===type && grid[r-2][c]===type) ||
                            (c>=2 && row[c-1]===type && row[c-2]===type)
                        );
                        
                        row.push(type);
                        
                        const el = document.createElement('div');
                        el.className = 'tile';
                        el.style.transform = `translate(${c*cfg.size}px, ${r*cfg.size}px)`;
                        el.innerText = emojis[type];
                        el.dataset.r = r;
                        el.dataset.c = c;
                        
                        this.attachInput(el);
                        
                        con.appendChild(el);
                        dRow.push(el);
                    }
                    grid.push(row);
                    domGrid.push(dRow);
                }
            },

            attachInput(el) {
                let startX, startY;
                let isDragging = false;

                el.ondragstart = () => false;

                const start = (e) => {
                    if(state.locked) return;
                    
                    const pos = { r: parseInt(el.dataset.r), c: parseInt(el.dataset.c) };
                    
                    if(state.activeTool) {
                        powerups.use(pos.r, pos.c);
                        return;
                    }

                    isDragging = true;
                    const t = e.touches ? e.touches[0] : e;
                    startX = t.clientX;
                    startY = t.clientY;
                    
                    if(!state.selected) {
                        this.select(pos.r, pos.c);
                    } else if (state.selected.r === pos.r && state.selected.c === pos.c) {
                        this.deselect();
                        isDragging = false;
                    } else {
                        const dr = Math.abs(state.selected.r - pos.r);
                        const dc = Math.abs(state.selected.c - pos.c);
                        if(dr + dc === 1) {
                            const oldSel = state.selected;
                            this.deselect();
                            this.attemptSwap(oldSel, pos);
                            isDragging = false;
                        } else {
                            this.select(pos.r, pos.c); 
                        }
                    }
                };

                const move = (e) => {
                    if(!isDragging || !state.selected || state.locked) return;
                    
                    const pos = { r: parseInt(el.dataset.r), c: parseInt(el.dataset.c) };
                    if(state.selected.r !== pos.r || state.selected.c !== pos.c) return; 

                    const t = e.touches ? e.touches[0] : e;
                    const dx = t.clientX - startX;
                    const dy = t.clientY - startY;
                    
                    if(Math.abs(dx) > 15 || Math.abs(dy) > 15) {
                        isDragging = false;
                        let targetR = pos.r;
                        let targetC = pos.c;
                        
                        if(Math.abs(dx) > Math.abs(dy)) {
                            targetC += dx > 0 ? 1 : -1;
                        } else {
                            targetR += dy > 0 ? 1 : -1;
                        }
                        
                        if(targetR >=0 && targetR < cfg.h && targetC >= 0 && targetC < cfg.w) {
                            this.attemptSwap(pos, {r:targetR, c:targetC});
                        }
                        this.deselect(); 
                    }
                };

                const end = () => { isDragging = false; };

                el.addEventListener('mousedown', start);
                el.addEventListener('touchstart', start, {passive: false});
                el.addEventListener('mousemove', move); 
                el.addEventListener('touchmove', move, {passive: false});
                el.addEventListener('mouseup', end);
                el.addEventListener('mouseleave', end);
                el.addEventListener('touchend', end);
            },

            select(r, c) {
                this.deselect();
                state.selected = {r, c};
                domGrid[r][c].classList.add('selected');
                audioSys.sfx('swap');
            },
            deselect() {
                if(state.selected) {
                    domGrid[state.selected.r][state.selected.c].classList.remove('selected');
                    state.selected = null;
                }
            },

            resetHint() {
                clearTimeout(hintTimer);
                document.querySelectorAll('.hint').forEach(e => e.classList.remove('hint'));
                hintTimer = setTimeout(() => this.showHint(), 5000);
            },

            showHint() {
                for(let r=0; r<cfg.h; r++) {
                    for(let c=0; c<cfg.w; c++) {
                        if(c<cfg.w-1) {
                            this.swapData(r, c, r, c+1);
                            if(this.findMatches().length > 0) {
                                domGrid[r][c].classList.add('hint');
                                domGrid[r][c+1].classList.add('hint');
                                this.swapData(r, c, r, c+1); 
                                return;
                            }
                            this.swapData(r, c, r, c+1); 
                        }
                        if(r<cfg.h-1) {
                            this.swapData(r, c, r+1, c);
                            if(this.findMatches().length > 0) {
                                domGrid[r][c].classList.add('hint');
                                domGrid[r+1][c].classList.add('hint');
                                this.swapData(r, c, r+1, c);
                                return;
                            }
                            this.swapData(r, c, r+1, c);
                        }
                    }
                }
            },

            async attemptSwap(p1, p2) {
                state.locked = true;
                this.resetHint();
                
                await this.animSwap(p1, p2);
                this.swapData(p1.r, p1.c, p2.r, p2.c);
                
                const matches = this.findMatches();
                
                if(matches.length > 0) {
                    state.moves--;
                    ui.updateStats();
                    await this.processMatches(matches);
                } else {
                    audioSys.sfx('bad');
                    this.swapData(p1.r, p1.c, p2.r, p2.c); 
                    
                    const t1 = domGrid[p1.r][p1.c];
                    const t2 = domGrid[p2.r][p2.c];
                    t1.style.transform = `translate(${p1.c*cfg.size}px, ${p1.r*cfg.size}px)`;
                    t2.style.transform = `translate(${p2.c*cfg.size}px, ${p2.r*cfg.size}px)`;
                    
                    await this.wait(250);
                    state.locked = false;
                }
            },

            swapData(r1, c1, r2, c2) {
                let temp = grid[r1][c1];
                grid[r1][c1] = grid[r2][c2];
                grid[r2][c2] = temp;
                
                let tEl = domGrid[r1][c1];
                domGrid[r1][c1] = domGrid[r2][c2];
                domGrid[r2][c2] = tEl;
                
                if(domGrid[r1][c1]) { domGrid[r1][c1].dataset.r = r1; domGrid[r1][c1].dataset.c = c1; }
                if(domGrid[r2][c2]) { domGrid[r2][c2].dataset.r = r2; domGrid[r2][c2].dataset.c = c2; }
            },

            animSwap(p1, p2) {
                return new Promise(resolve => {
                    const t1 = domGrid[p1.r][p1.c]; 
                    const t2 = domGrid[p2.r][p2.c];
                    
                    t1.style.transform = `translate(${p2.c*cfg.size}px, ${p2.r*cfg.size}px)`;
                    t2.style.transform = `translate(${p1.c*cfg.size}px, ${p1.r*cfg.size}px)`;
                    
                    setTimeout(() => resolve(), 250);
                });
            },

            findMatches() {
                let matched = new Set();
                for(let r=0; r<cfg.h; r++) {
                    for(let c=0; c<cfg.w-2; c++) {
                        let t = grid[r][c];
                        if(t === -1) continue;
                        if(grid[r][c+1] === t && grid[r][c+2] === t) {
                            matched.add(`${r},${c}`); matched.add(`${r},${c+1}`); matched.add(`${r},${c+2}`);
                        }
                    }
                }
                for(let c=0; c<cfg.w; c++) {
                    for(let r=0; r<cfg.h-2; r++) {
                        let t = grid[r][c];
                        if(t === -1) continue;
                        if(grid[r+1][c] === t && grid[r+2][c] === t) {
                            matched.add(`${r},${c}`); matched.add(`${r+1},${c}`); matched.add(`${r+2},${c}`);
                        }
                    }
                }
                return Array.from(matched).map(s => {
                    const [r, c] = s.split(',').map(Number);
                    return {r, c};
                });
            },

            async processMatches(matches) {
                this.deselect();
                audioSys.sfx('match');
                
                const baseScore = matches.length * 10;
                const bonus = matches.length > 3 ? (matches.length-3)*10 : 0;
                state.score += baseScore + bonus;
                ui.updateStats();

                const center = matches[Math.floor(matches.length/2)];
                this.floatText(center.r, center.c, `+${baseScore+bonus}`);

                for(let m of matches) {
                    const el = domGrid[m.r][m.c];
                    this.createParticles(m.r, m.c, el.innerText);
                    el.style.transform = `${el.style.transform} scale(0)`;
                    grid[m.r][m.c] = -1; 
                }

                await this.wait(300);
                await this.applyGravity();
            },

            async applyGravity() {
                let moved = false;
                
                for(let c=0; c<cfg.w; c++) {
                    let emptyCount = 0;
                    for(let r=cfg.h-1; r>=0; r--) {
                        if(grid[r][c] === -1) {
                            emptyCount++;
                        } else if (emptyCount > 0) {
                            this.swapData(r, c, r+emptyCount, c);
                            const el = domGrid[r+emptyCount][c];
                            el.style.transition = ""; 
                            el.style.transform = `translate(${c*cfg.size}px, ${(r+emptyCount)*cfg.size}px)`;
                            moved = true;
                        }
                    }
                    
                    for(let r=0; r<emptyCount; r++) {
                        const type = Math.floor(Math.random() * emojis.length);
                        grid[r][c] = type;
                        
                        let el = domGrid[r][c]; 
                        el.innerText = emojis[type];
                        el.style.transition = 'none';
                        el.style.transform = `translate(${c*cfg.size}px, -50px)`;
                        
                        void el.offsetWidth;
                        
                        el.style.transition = ""; 
                        el.style.transform = `translate(${c*cfg.size}px, ${r*cfg.size}px)`;
                        el.style.opacity = 1;
                        el.style.zIndex = 10;
                        moved = true;
                    }
                }

                if(moved) {
                    await this.wait(400);
                    const newMatches = this.findMatches();
                    if(newMatches.length > 0) {
                        await this.processMatches(newMatches);
                    } else {
                        state.locked = false;
                        this.resetHint();
                        this.checkWin();
                    }
                } else {
                    state.locked = false;
                    this.resetHint();
                }
            },

            createParticles(r, c, char) {
                const x = c * cfg.size + 20;
                const y = r * cfg.size + 20;
                
                for(let i=0; i<6; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.innerText = char; 
                    p.style.fontSize = '12px';
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const vel = Math.random() * 50 + 20;
                    p.style.setProperty('--dx', Math.cos(angle)*vel + 'px');
                    p.style.setProperty('--dy', Math.sin(angle)*vel + 'px');
                    
                    document.getElementById('grid').appendChild(p);
                    setTimeout(()=>p.remove(), 600);
                }
            },

            floatText(r, c, txt) {
                const el = document.createElement('div');
                el.className = 'floater';
                el.innerText = txt;
                el.style.left = (c*cfg.size + 10) + 'px';
                el.style.top = (r*cfg.size) + 'px';
                document.getElementById('grid').appendChild(el);
                setTimeout(()=>el.remove(), 1000);
            },

            checkWin() {
                if(state.score >= state.target) {
                    this.gameOver(true);
                } else if (state.moves <= 0) {
                    this.gameOver(false);
                }
            },

            gameOver(win) {
                state.locked = true;
                setTimeout(() => {
                    const res = document.getElementById('screen-result');
                    const btnContainer = document.getElementById('res-btns');
                    ui.nav('screen-result');
                    
                    if(win) {
                        audioSys.sfx('win');
                        const reward = levels[state.levelIdx].reward;
                        document.getElementById('res-title').innerText = "Sweet Victory!";
                        document.getElementById('res-msg').innerText = `Level Complete! Earned ${reward} Coins!`;
                        state.coins += reward;
                        
                        // Unlock Next Level
                        if((state.levelIdx + 1) === state.maxUnlocked && state.maxUnlocked < levels.length) {
                            state.maxUnlocked++;
                        }

                        // Button logic
                        btnContainer.innerHTML = '';
                        if((state.levelIdx + 1) < levels.length) {
                             const btnNext = document.createElement('button');
                             btnNext.className = 'btn';
                             btnNext.innerText = 'Next Level';
                             btnNext.onclick = () => game.startLevel(state.levelIdx + 1);
                             btnContainer.appendChild(btnNext);
                        }
                        
                        const btnMenu = document.createElement('button');
                        btnMenu.className = 'btn btn-pink';
                        btnMenu.innerText = 'Levels';
                        btnMenu.onclick = () => ui.nav('screen-levels');
                        btnContainer.appendChild(btnMenu);

                    } else {
                        document.getElementById('res-title').innerText = "Out of Moves";
                        document.getElementById('res-msg').innerText = "Don't give up!";
                        
                        btnContainer.innerHTML = '';
                        const btnRetry = document.createElement('button');
                        btnRetry.className = 'btn';
                        btnRetry.innerText = 'Try Again';
                        btnRetry.onclick = () => game.startLevel(state.levelIdx);
                        btnContainer.appendChild(btnRetry);

                        const btnMenu = document.createElement('button');
                        btnMenu.className = 'btn btn-pink';
                        btnMenu.innerText = 'Levels';
                        btnMenu.onclick = () => ui.nav('screen-levels');
                        btnContainer.appendChild(btnMenu);
                    }
                    ui.updateShop();
                }, 500);
            },

            wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        };

        const powerups = {
            activate(tool) {
                if(state.locked) return;
                if(state.inventory[tool] > 0) {
                    if(state.activeTool === tool) {
                        state.activeTool = null;
                        document.getElementById('grid').classList.remove('mode-active');
                    } else {
                        state.activeTool = tool;
                        document.getElementById('grid').classList.add('mode-active');
                        if(tool === 'shuffle') {
                            state.inventory.shuffle--;
                            this.doShuffle();
                            state.activeTool = null;
                            document.getElementById('grid').classList.remove('mode-active');
                            ui.updateShop();
                        }
                    }
                } else {
                    alert("Buy more in the shop!");
                }
            },
            use(r, c) {
                if(!state.activeTool) return;
                
                const tool = state.activeTool;
                state.inventory[tool]--;
                state.activeTool = null;
                document.getElementById('grid').classList.remove('mode-active');
                ui.updateShop();
                
                if(tool === 'hammer') {
                    audioSys.sfx('match');
                    this.destroyAt(r, c);
                }
                if(tool === 'bomb') {
                    audioSys.sfx('match');
                    for(let i=r-1; i<=r+1; i++) {
                        for(let j=c-1; j<=c+1; j++) {
                            if(i>=0 && i<cfg.h && j>=0 && j<cfg.w) this.destroyAt(i, j);
                        }
                    }
                }
                setTimeout(() => game.applyGravity(), 300);
            },
            destroyAt(r, c) {
                if(grid[r][c] !== -1) {
                    const el = domGrid[r][c];
                    game.createParticles(r, c, el.innerText);
                    el.style.transform = `${el.style.transform} scale(0)`;
                    grid[r][c] = -1;
                }
            },
            doShuffle() {
                let flat = [];
                for(let r=0; r<cfg.h; r++) for(let c=0; c<cfg.w; c++) if(grid[r][c]!==-1) flat.push(grid[r][c]);
                
                for(let i=flat.length-1; i>0; i--) {
                    const j = Math.floor(Math.random() * (i+1));
                    [flat[i], flat[j]] = [flat[j], flat[i]];
                }
                
                let k=0;
                for(let r=0; r<cfg.h; r++) {
                    for(let c=0; c<cfg.w; c++) {
                        if(grid[r][c]!==-1) {
                            grid[r][c] = flat[k++];
                            domGrid[r][c].innerText = emojis[grid[r][c]];
                            domGrid[r][c].style.transform = `scale(0)`;
                            setTimeout(() => {
                                domGrid[r][c].style.transform = `translate(${c*cfg.size}px, ${r*cfg.size}px) scale(1)`;
                            }, 50 + k*10);
                        }
                    }
                }
                game.resetHint();
            }
        };

        const market = {
            buy(item) {
                const prices = { hammer: 100, bomb: 250, shuffle: 150 };
                const msg = document.getElementById('shop-msg');
                if(state.coins >= prices[item]) {
                    state.coins -= prices[item];
                    state.inventory[item]++;
                    msg.innerText = "Purchased!";
                    msg.style.color = "green";
                    ui.updateShop();
                } else {
                    msg.innerText = "Not enough coins!";
                    msg.style.color = "red";
                }
            }
        };

        // Initialize Level Screen UI on load
        ui.buildLevelSelect();

    </script>
</body>
</html>
